<!--
+++
title       = "优化器-SDG: batch_size的选择"
description = "1. 划分batch的意义; 2. 数值选择; 3. 结合PC内存选择batch数值"
date        = "2021-12-19"
tags        = []
categories  = ["7-理论知识","71-机器学习"]
series      = []
keywords    = ["SDG","batch"]
weight      = 5
toc         = true
draft       = false
+++ -->

[TOC]

---

## 1. 划分batch的意义

Batch的思想，至少有两个作用：

1. 合理利用内存容量
1. 更好的处理非凸的损失函数

    非凸的情况下，全样本就算工程上算的动，也会卡在局部优上，批表示了全样本的部分抽样实现，相当于人为引入修正梯度上的采样噪声，使“一路不通找别路”更有可能搜索最优值

## 2. 数值选择

Batch 的选择，首先决定的是下降的方向。如果数据集比较小，完全可以采用全数据集（Full Batch Learning）的形式，这样做至少有 2 个好处：

+ 由全数据集确定的方向能够更好地代表样本总体，从而更准确地朝向极值所在的方向
+ 由于不同权重的梯度值差别巨大，因此选取一个全局的学习率很困难。 Full Batch Learning 可以使用 Rprop 只基于梯度符号并且针对性单独更新各权值。

对于更大的数据集，以上 2 个好处又变成了 2 个坏处：

+ 随着数据集的海量增长和内存限制，一次性载入所有的数据进来变得越来越不可行
+ 以 Rprop 的方式迭代，会由于各个Batch之间的采样差异性，各次梯度修正值相互抵消，无法修正。这才有了后来 RMSProp 的妥协方案。

既然 Full Batch Learning 并不适用大数据集，那么走向另一个极端怎么样？

所谓另一个极端，就是每次只训练一个样本，即 Batch_Size = 1。这就是在线学习（Online Learning）。线性神经元在均方误差代价函数的错误面是一个抛物面，横截面是椭圆。对于多层神经元、非线性网络，在局部依然近似是抛物面。使用在线学习，每次修正方向以各自样本的梯度方向修正，横冲直撞各自为政，难以达到收敛。

[deeec97a290e3101c05ae2cca43dee0a]:data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCABoAJUDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD3+qU+oxxuUjUyOOoXoPxpb+VkhCIcPIdoPoO9Z9/Kul6eGTAlc7VJGdvGS2O+APzxWU5b62S3NIQ5mkt2PuNUmhAMrwQZ6Bjkn8O9Vf7dkzw7N9Ldv8Kq2Wjy3YM07OC/JG7k/wC8epP6VePh6zRcukY92rG1SS5krLzb/TY3/cxdtX6WEHiEr/rMAf7Ubr/SrcGuQTdAG/65uGrOOkWan9zcCM/7EpH9agm0ifG4NHOP+mqAn/voYNJSqdNfRp/gwaovuvU6WK9t5ThZAD6NwasZriSJLfh/OgA9f30f6/MKuQX91AgcZeL/AJ6QHzE/Feo/DNXGs27b/g/uZMqGl4v+v68zqqKybXWY5lywVlHV4znH1HUVpRTRzLujcMPY1tGpGWhhKEo7klFFFWSFFFFABRRRQAUUUUAFFFFAFK+H723btuI/SsvxLGWt7dwMgb1/Hbn/ANlNbV3EZYGC/eHzL9RVWeL+0NNZEIEnDRk9mHI/WuecOZTh3/4Y3oz5JxkyxashtldOVI3DHpWfFbPfsZpmJB6DsBUeh3YC/Y3BXGTGG67c4K/VTx9MGtC1/cu8B6qcr7jtRGaqOLf9P+thTg6bcf6sZ+of2XpaI15cRxbzhFOSzH2Ucn8Kyzq+jocrdXEH+1JbSoPzK1dggSXxfqRuBmURwmEnqIsHOPbeGz+FbZtIiOlVZz7fdc0ap0rJpt2T3tur6aP8TEt7tbuMvbz299EOpjcMR+XT8ajNpBJIZLeRrac+nGfr2P41bvfDNhdP5vkhJx0miJSQfRlwazZrbVdO+/8A8TO2HZ8JOo9m4V/ocH3qJ03azWn3/wDBXyY48kn+7lZ+dl+Oz+aQSp5cmb2IxOOl1ACMf7w6j9RUwe4ttsrfvYyMrcQdce4HB/D8qdZ38V3CzQOZ40O2SJxtkiPowPINOFs8O6fT3G0nLwt90/Udj7j9ajXbdfj8n1+dpeY22nyzVmv69V8rryL9rqu6MM5EsZ4Esf8AUVpxypKgaNgynuK5uOOO7d5bRmtrxR+8ibnP1HRh7/yp8Fw6TiNv9GuT0Gfkk+h/oea0hJ2vF3X9f1Z/eZypp7f1/mvNfcdJRVG3vwzCOceXJ+hq9W0ZKWxg00FFFFUIKKKKACiiigAqiw+y3Of+WUh/Jv8A69XqZJGssZRxlT1qJxb1W6Gn3MTVbPy3+3QkquQ0jKMmNhwJAO/HDDuPpVi3uftq7TtjvIRkgHIYHuD3U+tWYnaGTyJTn+6394f41mXtj9iYSxlltlJZHQZa2J68d0Pcdv5c8439+HzX9bNdH+j06otTShLdbP8Ar+vmtX6lazXfk31iAuo2mQI3OBKp+9Gx7ZwCD2IB9avaZqcGp23mxFlZSUkjcYeNx1Vh2IqtDdedIkcxWG7xlHU5SYf7J7j26iobzT2mu/tlpILPVAoBYjMc6jorj+IehHI/SnCprdf1/k/Lr0G0pR5J6W2f6Py7Pp1VrpbtIyBhgjNZFnrim4Wy1GI2V8fuxyHKy+8b9GHt19RWwDmumMlLY5qlOVN2kv68u5hapoSzyC7tpGtryMYSeMcgehHRl9j+lUrK7lluXt5kW31KJdzIv3Jk/vpnqPUdR+RrqiM1ja5pRvIFlgfyruFvMgmA+4/+B6EdwaznC+q/r/g+ZrTqppQqbdH2/wCB3XzWu8Ulul8BJGTDdRcgqcFT6j2oiePUA1lfRqtyBkcfLKB3Hv7dqS0nOoadBqUKeVMQRJH/AHXBwy/gQRVi5tk1C1WaPKSKcgr1Rh6VlZ35o7/muz8/P9LpDvB8k+j+5+Xl/XYqOXsj5N6TJbdFnPLR/wC96j3/ADq9HPLZ4D5kgPQjkgf1FR2N7HqIlsrgoL6BQZUHdTna4HocH8QRUHzaQ+yQFrBj9fJ9x/s+3arVpJSWn5r+v67g1zPl6/g/+D+fqbsciSoHRgynoRT6yiklo/m25DRtyVzwRV+C4S4j3ofqD1BrSMnfllv+Zi11RNRRRVkhRRRQAUUUUARTQrMm1vqCOoPrUEcrxP5M/X+FuzVcqOWJJUKOMj+VRKLvzR3/ADKT6MybrTfKRjBCJrVjue1zgqf70Z7H2/LFMhuWEGSWvbMH74H76I+jDqceo59q0A8lo22U7oz0f/GmXFis8n2m2k8i5x99RkN7MO4/WsZU1PWOj/rfuv6TR0KpfSf3/wBfn96ZDJFb6jZFHSK/s3/hYAkf/XH4GqcdjfWh/wCJTqPmRj/l0v8ALhfYP99fx3U9gq3P78NYXjHAmjOY5T+PB+hwasPNNF/x/wBr5ijpcW4Jx9R94fhms7uPxffr+e6+aa8zROUVyrVPo7P/AID9U0/IiGtX1vxfaLeKf79tidD+WG/8dpJPEKTIUttN1OeU8BPsjR8+7PgD86vQSCdN9pdpKno3zY/Ecj8am8y4X70Ab3Vx/WtVNtXv+Cf4ozbp31hr6tfg9fxKeiafNZaYUutnnyyPNKqHKqzsW2g98ZxmpbRfLvJoh91hux71Dq2qXmn2D3FvpU93ICAIkdVJz35PQe2T7VzkF3b38rPrWsfZdw+az2vargdizYZ/zwfSrSTSUehlOblJyl1M3WdIvNM+J9p4oivSsE0P2RoU5V0QFmVvc/OR6FR716JLGk8XYgjg+tcRLbJafDayvFjVRbFb/ao4Cli7Af8AAXYV2enKy6Zaq/3hCoP5U7tVLdLfqTZcl+tzPs2On3IsJf8Aj3kP7gn+A/3Pp6fl6VYmhktpfPg/FexFSanZrdWzL0PUMOqnsfwp2n3BvbBHkA80ZSQejDg/596bin7rLb5lz9ev+f8AmT29wlxEHT6EHqDU1ZcivZT+dGCUP319RWlG6yIHU5UjINEZO/LLcza6odRRRVkhRRRQAUUUUAIVBBBGQeoNVGgktzug+ZO8ZPT6f4VcoqZQT16jTsVQ8F3E0ciq6nhkcfoRVX7Fc2fNjLvjH/LCZiQP91uo+hyKuzWySndyrjo69f8A69RebLb8TDKf316fj6VDdvj+/wDrb8jSMmtI6rs/6/LUoM1hc3AW6ga0vD0JPlufow4b8zVkW19D/qL4SL2W4jyf++lwatssF3CUkRJI2/hYZBqodNkg5sbp4h/zyk/eJ+vI/A1LoxvdL5rT/gMtVE1a9vJ6r/NC+fqScPYxSe8U/wDRgKx/E09yfDt6n9lENLH5KlpExuchB0J7sK1/td9b8XNkzj+/bneP++Tg/wA6w/FF+l9ZWtrbIkzPdJ5sMz+UAgBPzZ5xkL0yaFF/zv8AD/IHF2uoJ+l/0ZTbwxpE7CwlvbeyaVTELSzudjSYHRgCN3HONtaUWtXNnK+y3M2jWeLV5ly0u5RhpP8AaUH5SAM5DEZ6Vz2j2kOi2s0Q8uXxCjLZ28gQAbXHyOoHRQoJbuSjZJ4rYubzVdFSPStL0TzbSGNQLt5Vbce/yZUk55JLDmtIQUfMxlJs6tJY7mBZYpFkjkUMjochgehB7isODVrDS7y/iuruKImRWWMnLklRnCjk9PSuLE91b3q26rq9zBPIfNsbdViSNm/iXy3OBnqpODkkc9ehsNPSEyaZoyRxTbyb6+jUYjY9UQ/xOBxk5298ninuyknGLv1NvT9dtdbu7u1t7e6AtsB5ZYtilj/CMnOQOTwMZFWbRzb3DWzfdbJT2PcVNp+n2+mWaW1tGEjQdupPck9yTzk9aiv0KgSr95DuFKotOZbomO9jQopqMHRWHQjIoq07kjqKKKACiiigAooooAKTFLRQBWe0UMWhYxN7dD+FM8+WH/XR/L/fXkf/AFquUVnyW+F2/L7v8iua+5FHMkigqwI9qWSOOVdsiK49GGRUclpE53AFG/vIcUzy7qL7rLKPf5T/AIUczXxL7tf+CFuzKcvhnR5r+O+bT4BcRoUV1XaQD16fSnzaZpNrE01xFCkSDLNM/wAoHvk4qz9r2f62N09yOPzrF8Q6aPE0Q0yXyP7OdS0zEBnY9lGR8o7k9ewxyaE4S2sX7Squr+8ig1CHxEhtvD0saaYGKzX1tgByOCkRHf1ft0HPI6GzsoLC1jt7aNY4kGFVRgAVS8PaNZ+HNCs9Js+IbaMID3b1J9ycmtTePWtDNtvVjqq3pAt2z6VK86RrlmAHvVXDXrjgiAHJJ/i9h7VE5W0W44q+vQs2wK2sQPUIP5UVLiiqiuVJCbu7i0UUUxBRRRQAUUUUAFFFFABRRRQAUUUUAGKie2hk+9EhPriiik4qW6Gm1sR/Yoewdfo5o+xR93lP/AzRRUeyh2Hzy7jktIEORGCfVuT+tT0UVUYqOyE23uFFFFUI/9k=
![][deeec97a290e3101c05ae2cca43dee0a]

在合理范围内，增大Batch_Size有何好处？

1. 提高了内存的利用率，**大矩阵乘法的并行化效率提高**
2. 跑完一次epoch（全数据集）所需要的迭代次数减少，<font color=#FF0000>相同数据量的数据处理速度加快</font>
3. <font color=#FF0000>Batch_size越大下降方向越准</font>，引起的训练震荡越小

盲目增大 Batch_Size 有何坏处？

1. 内存溢出
2. 跑完一次 epoch（全数据集）所需的迭代次数减少，要想达到相同的精度，其所花费的时间大大增加了，从而对参数的修正也就显得更加缓慢
3. Batch_Size 增大到一定程度，其确定的下降方向已经基本不再变化

实验证明调节 Batch_Size 对训练效果影响到底如何

1. Batch_Size太小，算法容易修正方向<font color=#FF0000>导致不收敛</font>，或者需要经过很大的epoch才能收敛；
2. 随着 Batch_Size 增大，处理相同数据量的速度越快；
3. 随着 Batch_Size 增大，达到相同精度所需要的epoch数量越来越多；

由于上述两种因素的矛盾，Batch_Size 增大到某个时候，达到时间上的最优。

由于最终收敛精度会陷入不同的局部极值，因此 `Batch_Size` 增大到某些时候，达到最终收敛精度上的最优。

## 3. 结合PC内存选择batch数值

问：如果我们的显卡比较渣（例如2G），无法提高Batch_size，有什么办法挽救一下精度？

当batch_size无法提高的时候，可以把solver里面的iter_size调大一些，因为在每个随机梯度下降步骤中通过 `iter_size*batch_size` 实现累加梯度。所以增加iter_size也可以得到更稳定的梯度。
