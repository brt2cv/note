<!--
+++
title       = "图像质量测评"
description = "1. 图像质量; 2. 原理; 3. 测试工具; 4. Imatest; 5. ImageJ 测试; 6. 开源项目：image-quality-assessment"
date        = "2022-01-03"
tags        = []
categories  = ["7-理论知识","73-机器视觉"]
series      = []
keywords    = []
weight      = 5
toc         = true
draft       = false
+++ -->

[TOC]

---

## 1. 图像质量
> [wechat: 光学系统的像质评价和像差公差分析](https://mp.weixin.qq.com/)
>
> [论文: 数字射线扫描成像系统MTF的测试分析](http://www.xml-data.org/hejishu/html/2016/7/2016070203.htm)

Sharpness：锐度，也叫清晰度或者分辨率。

+ SQF：图像质量的主观因素
+ Noise：拍摄图像中的噪声
+ 色差：又叫做色边纹
+ 眩光：也叫镜头耀斑

色彩修正矩阵

布勒单元，MTF和DXO分析师的BxU

Imatest测试实验室-怎样建造一个测试实验室

## 2. 原理

### 2.1. MTF的基本介绍

MTF（Modulation Transfer Function）调制传递函数，也叫对比度传递函数。在介绍MTF前我们现需要了解OTF（Optical Transfer Function）光学传递函数。

1948年，美国人谢德第一次用光学传递函数的方法，以全新的方法来评价电视摄影系统的成像质量，并获得了巨大成功，在此后的五六十年代里，许多光学专家又继续做了大量理论研究和实践工作，使光学传递函数理论更加完善。现在，光学传递函数已经被全世界普遍的应用于光学系统设计和成像质量评估，由于光学传递函数既和光学系统像差有关，又和光学系统的衍射效果相关，因此用光学传递函数的评价方法是最全面、最客观、最科学的方法。

光学传递函数由调制传递函数和相位传递函数组成，由于相位传递函数测量精度不高，且相位传递对影像的影响较小，所以目前国内外在研究光学系统质量时，<font color=#FF0000>都不考虑相位传递函数的影响，只研究调制传递函数</font>。

MTF描述光信息通过光学媒介和光学器件的传递过程中，它的强弱随空间位置变化规律而改变。调制度等于最大亮度减最小亮度比上最大亮度加最小亮度，因此也叫对比度。MTF正是表征光学系统记录和还原调制度的能力，MTF等于影像的调制度比上景物的调制度，由于光线传播过程中的损失，影像中强光部分的相对亮度值要比景物强光部分的亮度值降低，而由于杂光、散射和衍射的影响，影像中弱光部分的相对亮度值要比景物弱光部分的亮度值高，一个理想的光学系统，既没有像差，又没有杂光、散射、反射、和吸收的光学系统，它的MTF值等于1，因此一般光学系统MTF值都小于1。

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202357565-959327175.jpg) <!-- 图像质量测评/图像质量测评-9.jpg -->

### 2.2. MTF曲线解读

MTF表示的是调制传递函数的值随空间频率和像场位置变化的函数关系，它有很多种类型，最主要的两种就是MTF值与空间频率的关系以及MTF值和像场半径的关系，空间频率的单位是线对/毫米（lp/mm），随着空间频率的增加MTF值逐渐减小；像场半径是像场上任意一点到像场中心的距离，在像场内的分辨率标板或光栅中的黑白线条，应按两个主要的方向放置，这两个方向是检验光学成像系统的法定方向，一个是平行于像场半径的弧矢方向，也叫径向，另一个是垂直于像场半径的子午方向，也叫切向。<font color=#FF0000>一般弧矢方向的MTF值要高于子午方向，像场中心的MTF值最高</font>，随之像场半径增大MTF值减小。

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202357901-538809105.jpg) <!-- 图像质量测评/图像质量测评-10.jpg -->

如下是两种典型的MTF曲线图，如何用它来评价一枚镜头的好坏，通过MTF曲线我们可以得到两个指标：

1. **锐度**

    锐度主要是10-40lp/mm或更高空间频率的MTF值，表明镜头再现细节的能力；

2. 明锐度

    明锐度主要是10lp/mm或更低空间频率的MTF值，表明镜头的反差表现。

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202358186-2038812067.jpg) <!-- 图像质量测评/图像质量测评-11.jpg -->

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202358447-1159743251.jpg) <!-- 图像质量测评/图像质量测评-12.jpg -->

### 2.3. MTF的计算

MTF的计算方法有很多，比如：

1. 使用条形目标的方法
2. 随机目标方法
3. **点扩散函数法**
4. 带宽受限激光散斑法
5. **倾斜边缘法**（Slanted Edge Method）

点扩散函数法和倾斜边缘法是工业界普遍使用的方法。点扩散函数法的缺点在于需要使用小于光学系统或镜头分辨率极限的点光源，这样使得成像器件很难获得足够强的信号。

倾斜边缘法的算法流程下图，首先获取倾斜边缘的边缘扩散函数（ESF），然后求导得到对应的线扩散函数（LSF），最后傅里叶变换得到MTF。

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202358714-482021752.jpg) <!-- 图像质量测评/图像质量测评-13.jpg -->

## 3. 测试工具

### 3.1. DxO Analyzer

法国DxO影像测试系统DxO Analyzer是目前国际公认的最全面最精确的图像质量客观测试系统。 DxO Analyzer可以测试6千万像素，近乎所有客观像质参数。DxO系统不仅可以测试镜头、sensor/ISP/video,甚至是多阵列的摄像头，是现今最全面、最高效、最便利的图像质量测试系统。

DxO Analyzer的测试原理是：`光源+测试卡+DxO Analyzer=测试结果` 。我们通过各种各样的光源模拟各种光照环境，并在这些光照环境下按要求拍摄，把拍摄到的照片传输到DxO Analyzer中。DxO影像测试系统自动分辨照片是否符合规格，符合规格就可以直接分析得出结果，不符合规格就需要重新拍摄、上传。测试结果与工作人员的操作没有关系，全球各地的DxO Analyzer都可以重复测试得到相同的结果，也就是说结果是可重现的。

## 4. Imatest
> [官方教程](http://pcv.oss-cn-shanghai.aliyuncs.com/www.p-chao.com/2019/11/Imatest-Documentation.pdf)

+ SFR: 测试解析力，选择图像的斜边，使用刃边法解算MTF
+ Colorcheck: 测试色彩还原、AWB和信噪比
+ StepChart: 灰阶测试
+ Dynamic Range: 动态范围测试（可以分析灰阶测试卡，也可以分析动态范围测试卡）
+ Light Falloff: 测试color shaddng
+ Distortion: 测试畸变

### 4.1. 成像质量测试

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202358957-1043870098.jpg) <!-- 图像质量测评/图像质量测评-0.jpg -->

使用相机取图

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202359293-558487270.jpg) <!-- 图像质量测评/图像质量测评-1.jpg -->

选择黑色和白色交界的区域，一共需要测10次，位置分别为：

+ 中间横向
+ 中间纵向
+ 四角的横向 & 纵向

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202359630-1109576808.jpg) <!-- 图像质量测评/图像质量测评-2.jpg -->

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202359968-1291867573.jpg) <!-- 图像质量测评/图像质量测评-3.jpg -->

图像分析：首要看CA的值，单位为pixels。

+ 0~0.5：色散控制极佳
+ 0.5~1.0：较好范围
+ 1.0~1.5：人肉眼可识别，中等镜头
+ 1.5以上：镜头较差，影响成像质量

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202400300-551929557.jpg) <!-- 图像质量测评/图像质量测评-6.jpg -->

MTF50：

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202400848-539520540.jpg) <!-- 图像质量测评/图像质量测评-5.jpg -->

### 4.2. 色彩还原测试

色彩还原指彩色CCD、CMOS经过拍摄加工后，彩色摄影画面的色彩大体上和原景物的色彩相一致。影响色彩还原的因素有CCD、CMOS的性能，摄影镜头的质量，光线的色温等。今天我们通过在D65光源下测试摄像头对色彩的还原能力来聊聊如何使用Imatest进行色彩还原测试。

1. 调节摄像头的驱动参数调试到最佳，摄像头拍照相关的参数设置为普通模式，如白平衡设置为自动，曝光设为自动等；
2. 调节光源及照度到指定的标准
3. 将24色色卡置于灯箱正面中心，色卡中心与边缘照度不大于10%。调节摄像头位置，使摄像头正对色卡中心，并使标板占据模组预览画面75%以上，待图像稳定后拍照。

    ![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202401208-1777738938.jpg) <!-- 图像质量测评/图像质量测评-7.jpg -->

4. 框选ROI，务必将24color都选在框内
5. 测试结果

    ![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202402144-169338210.jpg) <!-- 图像质量测评/图像质量测评-8.jpg -->

### 4.3. 分析动态范围

> [使用36阶动态范围测试卡和Imatest分析动态范围](http://www.sineimage.com/baike/imatest/573.html)

## 5. ImageJ 测试

ImageJ 需要下载安装 [`Slanted Edge Modulation Transfer Function`](https://imagej.nih.gov/ij/plugins/se-mtf/index.html) 插件，需要注意的是<font color=#FF0000>只能测量竖直倾斜边缘，从左至右由黑变白的矩形框</font>，具体选项设置参考如下，sensor size单位是mm。

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202402395-1297971939.jpg) <!-- 图像质量测评/图像质量测评-17.jpg -->

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202402639-1073961470.jpg) <!-- 图像质量测评/图像质量测评-16.jpg -->

可以得到如下4张图表，除了MTF外还有ESF、LSF、SPP，比较方便的一点是我们通过Data-Add将不同的MTF曲线添加至一张图表中进行对比分析。

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202403012-94910510.jpg) <!-- 图像质量测评/图像质量测评-15.jpg -->

## 6. 开源项目：image-quality-assessment

> [一行命令搞定图像质量评价](https://blog.csdn.net/javastart/article/details/104855127)
>
> [github](https://github.com/idealo/image-quality-assessment)

来自德国商品比价服务商idealo开源的图像质量评价工具。这个工具还是很靠谱的，其参考的是Google 2017年研究论文 [NIMA: Neural Image Assessment](https://arxiv.org/pdf/1709.05424.pdf)，另外这家公司本身也在自己的互联网服务中使用该工具，用于用户上传的酒店图像的挑选和推荐。

实际上该工具有美学评价（侧重于图像好看不好看）和技术评价（侧重于图像质量好不好）两方面。

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202403399-108707630.jpg) <!-- 图像质量测评/图像质量测评-14.jpg -->

![](https://img2020.cnblogs.com/blog/2039866/202009/2039866-20200901202403715-865036310.jpg) <!-- 图像质量测评/图像质量测评-18.jpg -->

官方已经给出了这两个的预训练模型。当然，并不是每个人都是做这两个方面，比如我刚才说的监控场景的图像质量评价，那你就需要自己训练了。作者也提供了简单易用的训练接口。标注好样本，配置好环境后，训练也只需要一行命令：

```sh
./train-local \
--config-file $(pwd)/models/MobileNet/config_technical_cpu.json \
--samples-file $(pwd)/data/TID2013/tid_labels_train.json \
--image-dir /path/to/image/dir/local
```
